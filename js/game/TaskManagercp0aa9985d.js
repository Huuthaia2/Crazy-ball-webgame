var touch;!function(t){var s;!function(t){t[t.DIAMOND=0]="DIAMOND",t[t.SKIN=1]="SKIN"}(s=t.REWARD_TYPE||(t.REWARD_TYPE={}));var e;!function(t){t[t.NONE=0]="NONE",t[t.TOTAL_DISTANCE=1]="TOTAL_DISTANCE",t[t.TOTAL_SURPASS=2]="TOTAL_SURPASS",t[t.BEST_DISTANCE=3]="BEST_DISTANCE",t[t.BEST_SURPASS=4]="BEST_SURPASS"}(e=t.TASK_VALUE_TYPE||(t.TASK_VALUE_TYPE={}));var r;!function(t){t[t.NEW=0]="NEW",t[t.FINISHED=1]="FINISHED"}(r=t.TASK_STATE||(t.TASK_STATE={}));var a=function(){function a(){this._inited=!1,this._skinTasks=[],this._isDirty=!1}return Object.defineProperty(a,"instance",{get:function(){return this._inst||(this._inst=new a),this._inst},enumerable:!1,configurable:!0}),a.prototype.init=function(){this._inited||(this._inited=!0,this._initSkinTasks(),this.load())},a.prototype._initSkinTasks=function(){this._skinTasks=t.GameData.instance.config.tasks.skins},a.prototype.getSkinUnlockTasks=function(){return this._skinTasks},a.prototype.getSkinUnlockCondition=function(t){for(var e,r=0;r<this._skinTasks.length;r++){var a=this._skinTasks[r];if(a.rewardType==s.SKIN&&a.rewardValue==t){e=a;break}}return e},a.getTaskDesc=function(t){var s="";switch(t.type){case e.NONE:s="Diamond "+t.value;break;case e.TOTAL_DISTANCE:s="Run "+t.value+" meters";break;case e.TOTAL_SURPASS:s="Surpass "+t.value+" players"}return s},a.getTaskProgress=function(t,s){return s+"/"+t.value},a.prototype.load=function(){var t=this;this._initProgress(),this._states=[];var s=Laya.LocalStorage.getItem(a.DATA);if(null==s||""==s)return this._migrateOldProgress(),void this.save();var e=JSON.parse(s);e.progress&&e.progress.forEach(function(s){t.setTaskProgress(s.type,s.value)}),e.states&&e.states.forEach(function(s){s&&s.id>0&&t._setTaskState(s.id,s.state)})},a.prototype._initProgress=function(){this._progress=[],this._progress.push({type:e.TOTAL_SURPASS,value:0}),this._progress.push({type:e.TOTAL_DISTANCE,value:0}),this._progress.push({type:e.BEST_SURPASS,value:0}),this._progress.push({type:e.BEST_DISTANCE,value:0})},a.prototype._migrateOldProgress=function(){var s=t.GameData.instance.videoNums[t.GameData.getProgressIdByType(e.TOTAL_SURPASS)],r=t.GameData.instance.videoNums[t.GameData.getProgressIdByType(e.TOTAL_DISTANCE)];this.setTaskProgress(e.TOTAL_SURPASS,s),this.setTaskProgress(e.TOTAL_DISTANCE,r),this.setTaskProgress(e.BEST_SURPASS,t.GameData.instance.getOldSurpassRecord()),this.setTaskProgress(e.BEST_DISTANCE,t.GameData.instance.getOldDistanceRecord()),console.info("Surpass: "+s),console.info("Distance: ",r)},a.prototype.save=function(){var t={progress:this._progress,states:this._states},s=JSON.stringify(t);Laya.LocalStorage.setItem(a.DATA,s),this._isDirty=!1},a.prototype.setTaskProgress=function(t,s){var e=this.getTaskProgress(t);e?e.value=s:this._progress.push({type:t,value:s})},a.prototype.getTaskProgress=function(t){for(var s=null,e=0;e<this._progress.length;e++)if(this._progress[e].type==t){s=this._progress[e];break}return s},a.prototype.getTaskProgressValue=function(t,s){void 0===s&&(s=0);var e=this.getTaskProgress(t);return e?e.value:s},a.prototype.getBestDistance=function(){return this.getTaskProgressValue(e.BEST_DISTANCE,0)},a.prototype.setBestDistance=function(t){return t>this.getBestDistance()&&(this.setTaskProgress(e.BEST_DISTANCE,t),this._isDirty=!0,!0)},a.prototype.getBestSurpass=function(){return this.getTaskProgressValue(e.BEST_SURPASS,0)},a.prototype.setBestSurpass=function(t){return t>this.getBestSurpass()&&(this.setTaskProgress(e.BEST_SURPASS,t),this._isDirty=!0,!0)},a.prototype.addTaskProgress=function(t,s){var e=this.getTaskProgress(t);e?this.setTaskProgress(t,e.value+s):this.setTaskProgress(t,s),this.updateTaskStates()},a.prototype.addDistance=function(t){this.addTaskProgress(e.TOTAL_DISTANCE,t)},a.prototype.addSurpass=function(t){this.addTaskProgress(e.TOTAL_SURPASS,t)},a.prototype._getTaskState=function(t){for(var s=null,e=0;e<this._states.length;e++)if(this._states[e].id==t){s=this._states[e];break}return s},a.prototype._newTaskState=function(t){return{id:t,state:r.NEW}},a.prototype._setTaskState=function(t,s){var e=this._getTaskState(t);return e||(e=this._newTaskState(t),this._states.push(e)),e.state=s,this._isDirty=!0,e},a.prototype._isTaskFinished=function(t){var s=this._getTaskState(t);return!!s&&s.state>=r.FINISHED},a.prototype.updateTaskStates=function(){for(var r=0;r<this._skinTasks.length;r++){var a=this._skinTasks[r];if(!this._isTaskFinished(a.id))if(a.rewardType==s.SKIN&&t.SkinManager.isSkinUnlocked(a.rewardValue))this._finishTask(a),a.type===e.TOTAL_DISTANCE&&SdkHelper.EventLogger.logMoveDistance(a.value),a.type===e.TOTAL_SURPASS&&SdkHelper.EventLogger.logOverPlayer(a.value);else if(a.type!=e.NONE){this.getTaskProgress(a.type).value>=a.value&&this._finishTask(a)}}this._saveOnDirty()},a.prototype._finishTask=function(s){this._setTaskState(s.id,r.FINISHED),t.GameModule.instance.event(t.GameEvent.TASK_FINISHED,s)},a.prototype._saveOnDirty=function(){this._isDirty&&this.save()},a.DATA="Task",a}();t.TaskManager=a}(touch||(touch={}));