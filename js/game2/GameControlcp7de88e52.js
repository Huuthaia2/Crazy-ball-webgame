var game2;!function(e){var t=function(){function t(){this._skinIndex=0,this._touchBegin=!1,this._touchPosX=0,this._moveDirePosX=0,this._curBendTime=0,this._changeTime=0,this._dstIndex=0,e.EventCenter.instance.init(),e.AssetLoader.instance.init()}return t.prototype.preloadResource=function(t,s){var a=[];a.push(e.GameConfig2.Assets.SPEED_WIND_NODE),a.push(e.GameConfig2.Assets.DEAD_POINT_MESH),a.push(e.GameConfig2.Assets.BOOST_MESH),a.push(e.GameConfig2.Assets.PLANE_MESH),a.push(e.GameConfig2.Assets.PLANE_TEX),a.push(e.GameConfig2.Assets.WHITE_CUBE_TEX),a.push(e.GameConfig2.Assets.CUBE_TEX);for(i=0;i<e.GameConfig2.Assets.SKINS.length;i++)a.push(e.GameConfig2.Assets.SKINS[i]);for(var i=0;i<e.GameConfig2.Assets.AI_NAMES.length;i++)a.push(e.GameConfig2.Assets.AI_NAMES[i]);e.AssetLoader.instance.loadAssetsAsync(a,t,s)},t.prototype.resetSceneParameters=function(){this._curBendTime=0,this._dstIndex=3,this._changeTime=739,this._curBendAngle=new Laya.Vector4(0,0,0,0),this._gameWorld.reset()},t.prototype.initScene=function(){this._scene=new Laya.Scene,Laya.stage.addChild(this._scene),this._camera=new Laya.Camera(0,.1,100),this._scene.addChild(this._camera),this._camera.transform.rotate(new Laya.Vector3(-.05,0,0),!0,!0),this._camera.transform.position=new Laya.Vector3(0,1.5,7.5),this._camera.clearColor=null,this._light=new Laya.PointLight,this._light.transform.position=new Laya.Vector3(0,20,7.5),this._light.range=100,this._light.attenuation=new Laya.Vector3(0,0,0),this._scene.addChild(this._light),this._gameWorld=new e.GameWorld,this._gameWorld.addToScene(this._scene),this.resetSceneParameters()},Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),t.prototype.prepareMaterials=function(){e.GameWorld.prepare(),e.BallControl.prepare()},t.prototype.setupScene=function(){this._speedWind=e.AssetLoader.instance.get(e.GameConfig2.Assets.SPEED_WIND_NODE.key),this._scene.addChild(this._speedWind),this._speedWind.active=!0,this._gameWorld.setup(),this._currentBall=this.addBall(2),this._currentBall.disableAutoDrive();var t=[0,1,3,4];this._aiBalls=[];for(var s=0;s<t.length;s++){var a=t[s],i=this.addBall(a);i.setNameId(s),i.enableAutoDrive(this._gameWorld),this._aiBalls.push(i)}Laya.stage.bgColor=touch.MathUtil.vec4ToHexStr(touch.SkinManager.bgColors[this._skinIndex]),Laya.timer.frameLoop(1,this,this.onFrameUpdate),Laya.stage.on(Laya.Event.MOUSE_DOWN,this,this.onMouseDown),Laya.stage.on(Laya.Event.MOUSE_UP,this,this.onMouseUp)},t.prototype.addBall=function(t){var s=this._skinIndex,a=touch.SkinManager.fogColors[s],i=new Laya.Vector4(1,1,1,1),n=e.AssetLoader.instance.get(e.GameConfig2.Assets.SKINS[s]),o=e.BallControl.createBall(n,i,a);o.addTo(this._scene);var r=t-2;return o.setPosition(r,.25,0),o.speed=.6*e.MyUtils.randomFloat(20,40),o},t.prototype.onFrameUpdate=function(){var e=Laya.timer.delta/1e3;this.updateScene(e)},Object.defineProperty(t.prototype,"_isGameStopped",{get:function(){return!this._currentBall.isAlive},enumerable:!1,configurable:!0}),t.prototype.updateScene=function(e){if(this._isGameStopped)this._speedWind.active=!1;else{if(this._touchBegin){var t=this.udpateTouchInput();this._currentBall.autoDrive||this._currentBall.moveOnXAxis(t)}this._currentBall.update(e),this.updateCamera(e);for(var s=0;s<this._aiBalls.length;s++){var a=this._aiBalls[s];a.isAlive&&a.update(e)}console.info("Player lane: "+Math.floor(this._currentBall.position.x-2.5)),this._gameWorld.updateWorld(e,this._currentBall),this.updateBendEffect(e)}},t.prototype.updateCamera=function(e){this._camera.transform.rotation=new Laya.Quaternion(this._camera.transform.rotation.x,0,this._currentBall.transform.position.x/50,1);this._camera.transform.position=new Laya.Vector3(.5*this._currentBall.transform.position.x,1.5,this._currentBall.transform.position.z+4),33<this._currentBall.speed?90>this._camera.fieldOfView&&(this._camera.fieldOfView+=2):60<this._camera.fieldOfView&&(this._camera.fieldOfView-=.36),this._light.transform.position=new Laya.Vector3(0,20,this._camera.transform.position.z),this._speedWind.transform.position=new Laya.Vector3(0,this._camera.transform.position.y+.5,this._camera.transform.position.z-15);var t=this._speedWind.getChildAt(0);if(this._currentBall.speed>=25){this._speedWind.active=!0;var s=7*(this._currentBall.speed-24);t.particleSystem.emission.emissionRate=s}else this._speedWind.active=!1,t.particleSystem.emission.emissionRate=0},t.prototype.onMouseDown=function(){this._touchBegin=!0,this._touchPosX=Laya.stage.mouseX},t.prototype.onMouseUp=function(){this._touchBegin=!1,this._moveDirePosX=0,this._touchPosX=0},t.prototype.udpateTouchInput=function(){var e=Laya.stage.mouseX-this._touchPosX;this._touchPosX=Laya.stage.mouseX;var t=0;return t=Laya.stage.mouseX<=370?2.1*Laya.stage.mouseX/370-2.1:2.1*(Laya.stage.mouseX-370)/370,t*=1.5,t=2.1<t?2.1:t,t=t<-2.1?-2.1:t,this._moveDirePosX=e>0?1:-1,t},t.prototype.updateBendEffect=function(e){this._curBendTime+=this._currentBall.speed/24*Laya.timer.delta,this._curBendTime>=this._changeTime&&(this._dstIndex=this.randomAngle(this._dstIndex),this._changeTime=touch.GameDefine.BEND_TIMES[this._dstIndex],this._curBendTime=0);var t=this._curBendTime/this._changeTime,s=touch.GameDefine.DST_ANGLES[this._dstIndex],a=new Laya.Vector4(0,0,0,0);Laya.Vector4.lerp(this._curBendAngle,s,t/20,a);this._gameWorld.updateBendEffectAndDistance(a,100),this._currentBall.updateBendEffectAndDistance(a,100);for(var i=0;i<this._aiBalls.length;i++){var n=this._aiBalls[i];n.isAlive&&n.updateBendEffectAndDistance(a,100)}if(this._speedWind.active){var o=this._speedWind.getChildAt(0);null!=o&&o._render.material.setBendOffset(a)}this._curBendAngle=a},t.prototype.randomAngle=function(e){var t=0;do{t=Math.floor(Math.random()*touch.GameDefine.BEND_TIMES.length)}while(t==e);return t},t}();e.GameControl=t}(game2||(game2={}));